/**
 * better-auth configuration for authentication server
 * Generated by better-auth-setup skill
 *
 * Configuration:
 * - Database: {{DATABASE_PROVIDER}}
 * - Email Verification: {{EMAIL_VERIFICATION_REQUIRED}}
 * - Session Expiration: {{SESSION_EXPIRATION}} seconds ({{SESSION_EXPIRATION_DAYS}} days)
 * - Deployment: {{DEPLOYMENT_TARGET}}
 */
import { betterAuth } from 'better-auth';
import { prismaAdapter } from 'better-auth/adapters/prisma';
import { prisma } from '../database/client.js';
import { env } from '../config/env.js';
{{#OAUTH_ENABLED}}
import { oauth } from 'better-auth/plugins';
{{/OAUTH_ENABLED}}
{{#TWO_FACTOR_ENABLED}}
import { twoFactor } from 'better-auth/plugins';
{{/TWO_FACTOR_ENABLED}}
{{#MAGIC_LINK_ENABLED}}
import { magicLink } from 'better-auth/plugins';
{{/MAGIC_LINK_ENABLED}}

export const auth = betterAuth({
  // Database adapter using Prisma
  database: prismaAdapter(prisma, {
    provider: '{{DATABASE_PROVIDER}}',
  }),

  plugins: [
    {{#OAUTH_ENABLED}}
    oauth({
      {{#GOOGLE_OAUTH}}
      google: {
        clientId: env.googleClientId,
        clientSecret: env.googleClientSecret,
      },
      {{/GOOGLE_OAUTH}}
      {{#GITHUB_OAUTH}}
      github: {
        clientId: env.githubClientId,
        clientSecret: env.githubClientSecret,
      },
      {{/GITHUB_OAUTH}}
      {{#APPLE_OAUTH}}
      apple: {
        clientId: env.appleClientId,
        clientSecret: env.appleClientSecret,
      },
      {{/APPLE_OAUTH}}
    }),
    {{/OAUTH_ENABLED}}
    {{#TWO_FACTOR_ENABLED}}
    twoFactor({
      type: '{{TWO_FACTOR_TYPE}}', // 'totp' or 'sms'
    }),
    {{/TWO_FACTOR_ENABLED}}
    {{#MAGIC_LINK_ENABLED}}
    magicLink({
      expiresIn: 60 * 10, // 10 minutes
    }),
    {{/MAGIC_LINK_ENABLED}}
  ],

  // Email and password authentication
  emailAndPassword: {
    enabled: {{EMAIL_PASSWORD_ENABLED}},
    requireEmailVerification: {{EMAIL_VERIFICATION_REQUIRED}},
    minPasswordLength: {{MIN_PASSWORD_LENGTH}},
    maxPasswordLength: {{MAX_PASSWORD_LENGTH}},
  },

  // Session configuration
  session: {
    modelName: 'userSession',
    expiresIn: {{SESSION_EXPIRATION}}, // {{SESSION_EXPIRATION_DAYS}} days (in seconds)
    updateAge: {{SESSION_UPDATE_AGE}}, // Refresh daily (in seconds)
    cookieCache: {
      enabled: true,
      maxAge: 60 * 5, // 5 minutes
    },
  },

  // JWT configuration
  secret: env.jwtSecret,

  // Advanced session settings
  advanced: {
    crossSubDomainCookies: {
      enabled: {{CROSS_SUBDOMAIN_COOKIES}},
    },
    useSecureCookies: env.nodeEnv === 'production',
    cookiePrefix: 'better-auth',
    defaultCookieAttributes: {
      httpOnly: true,
      secure: env.nodeEnv === 'production',
      sameSite: env.nodeEnv === 'production' ? '{{SAME_SITE_PRODUCTION}}' : 'lax',
      path: '/',
    },
  },

  // Rate limiting
  rateLimit: {
    enabled: {{RATE_LIMIT_ENABLED}},
    window: {{RATE_LIMIT_WINDOW}}, // seconds
    max: {{RATE_LIMIT_MAX}}, // requests per window
  },

  // Trusted origins for CORS
  trustedOrigins: env.corsOrigins,
});

export default auth;
