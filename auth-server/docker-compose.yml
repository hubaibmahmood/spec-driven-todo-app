version: '3.8'

# Auth Server for Momentum Todo App
# Database: Neon Serverless PostgreSQL (configured via DATABASE_URL)

services:
  auth-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: momentum-auth-server
    ports:
      - "3002:3002"
    environment:
      # Server Configuration
      - NODE_ENV=production
      - PORT=3002

      # Database (shared with FastAPI backend)
      - DATABASE_URL=${DATABASE_URL}

      # better-auth Configuration
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL:-http://localhost:3002}

      # Frontend URL for CORS
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}

      # Email Configuration (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@momentum.intevia.cc}

      # JWT Configuration (for hybrid auth)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}

    networks:
      - momentum-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  momentum-network:
    driver: bridge
