# ============================================================================
# Momentum - Complete Microservices Stack
# ============================================================================
# This docker-compose orchestrates all 5 microservices:
#   - Frontend (Next.js) - Port 3000
#   - Auth Server (Node.js/better-auth) - Port 3002
#   - Backend API (FastAPI) - Port 8000
#   - MCP Server (Python/FastMCP) - Port 8001
#   - AI Agent (Python/Gemini) - Port 8002
#
# Database: Neon serverless PostgreSQL (cloud-hosted, configured via DATABASE_URL)
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # Auth Server (Node.js + Express + better-auth)
  # ==========================================================================
  auth-server:
    build:
      context: ./auth-server
      dockerfile: Dockerfile
    container_name: momentum-auth-server
    ports:
      - "3002:3002"
    environment:
      # Server configuration
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3002

      # Database (Neon serverless PostgreSQL - Prisma format)
      - DATABASE_URL=${PRISMA_DATABASE_URL}

      # better-auth configuration
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL:-http://localhost:3002}

      # CORS configuration
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}

      # Email configuration (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@momentum.intevia.cc}

      # JWT configuration (shared with backend)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
    networks:
      - momentum-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # Backend API (FastAPI + SQLAlchemy + PostgreSQL)
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: momentum-backend-api
    ports:
      - "8000:8000"
    environment:
      # Database configuration (Neon serverless PostgreSQL - provide via .env)
      - DATABASE_URL=${DATABASE_URL}

      # JWT configuration (shared with auth-server)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}

      # Service authentication
      - SERVICE_AUTH_TOKEN=${SERVICE_AUTH_TOKEN}

      # CORS configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}

      # Application settings
      - ENV=${ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    networks:
      - momentum-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # MCP Server (Model Context Protocol - Tool Calling Layer)
  # ==========================================================================
  mcp-server:
    build:
      context: .
      dockerfile: mcp-server/Dockerfile
    container_name: momentum-mcp-server
    ports:
      - "8001:8001"
    environment:
      # Service authentication
      - SERVICE_AUTH_TOKEN=${SERVICE_AUTH_TOKEN}

      # Backend API URL (Docker service name)
      - FASTAPI_BASE_URL=http://backend:8000

      # MCP server configuration
      - MCP_LOG_LEVEL=${MCP_LOG_LEVEL:-INFO}
      - MCP_SERVER_PORT=8001
      - BACKEND_TIMEOUT=${BACKEND_TIMEOUT:-30.0}
      - BACKEND_MAX_RETRIES=${BACKEND_MAX_RETRIES:-2}

    depends_on:
      backend:
        condition: service_healthy
    networks:
      - momentum-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python.*server"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # AI Agent (Gemini 2.5 Flash - Natural Language Task Management)
  # ==========================================================================
  ai-agent:
    build:
      context: .
      dockerfile: ai-agent/Dockerfile
    container_name: momentum-ai-agent
    ports:
      - "8002:8002"
    environment:
      # Application settings
      - ENV=${ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database (Neon serverless PostgreSQL - provide via .env)
      - DATABASE_URL=${DATABASE_URL}

      # Service authentication
      - SERVICE_AUTH_TOKEN=${SERVICE_AUTH_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}

      # Backend service URL
      - BACKEND_URL=http://backend:8000

      # CORS origins
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}

      # Gemini AI configuration
      - AGENT_GEMINI_API_KEY=${AGENT_GEMINI_API_KEY}
      - AGENT_MCP_SERVER_URL=http://mcp-server:8001/mcp
      - AGENT_MCP_TIMEOUT=10
      - AGENT_MCP_RETRY_ATTEMPTS=3
      - AGENT_TEMPERATURE=0.7
      - AGENT_TOKEN_BUDGET=800000
      - AGENT_ENCODING_NAME=cl100k_base

      # Optional OpenAI tracing
      - AGENT_OPENAI_API_KEY=${AGENT_OPENAI_API_KEY:-}

    depends_on:
      backend:
        condition: service_healthy
      mcp-server:
        condition: service_started
    networks:
      - momentum-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # Frontend (Next.js 16 App Router + React 19 + TypeScript)
  # ==========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Public environment variables (embedded at build time)
        NEXT_PUBLIC_AUTH_URL: ${NEXT_PUBLIC_AUTH_URL:-http://localhost:3002/api/auth}
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
        NEXT_PUBLIC_AI_AGENT_URL: ${NEXT_PUBLIC_AI_AGENT_URL:-http://localhost:8002}
        NEXT_PUBLIC_DOMAIN_KEY: ${NEXT_PUBLIC_DOMAIN_KEY:-local-dev}
        NEXT_PUBLIC_GA_MEASUREMENT_ID: ${NEXT_PUBLIC_GA_MEASUREMENT_ID:-}

    container_name: momentum-frontend
    ports:
      - "3000:3000"
    environment:
      # Runtime environment variables
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000

      # Internal Docker service URLs (for server-side API proxying)
      - INTERNAL_AUTH_URL=http://auth-server:3002
      - INTERNAL_API_URL=http://backend:8000
      - INTERNAL_AI_AGENT_URL=http://ai-agent:8002

    depends_on:
      auth-server:
        condition: service_healthy
      backend:
        condition: service_healthy
      ai-agent:
        condition: service_healthy
    networks:
      - momentum-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ============================================================================
# Networks
# ============================================================================
networks:
  momentum-network:
    driver: bridge
    name: momentum-network
