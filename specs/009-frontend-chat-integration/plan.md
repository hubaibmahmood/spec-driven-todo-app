# Implementation Plan: Frontend Chat Integration

**Branch**: `009-frontend-chat-integration` | **Date**: 2025-12-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/009-frontend-chat-integration/spec.md`

**Note**: This plan is generated by the `/sp.plan` command following Spec-Driven Development workflow.

## Summary

Integrate OpenAI ChatKit SDK into the Next.js frontend to provide an embedded, collapsible chat interface for natural language task management. The chat panel connects to the existing POST /api/chat endpoint (spec 008), handles authentication via better-auth session tokens (spec 004), and displays conversation history from the chat persistence service (spec 007). Users can create, update, and manage tasks using natural language while seeing real-time feedback as the AI agent processes operations. The chat panel is responsive: side panel on desktop (≥768px) and full-screen overlay on mobile (<768px).

## Technical Context

**Language/Version**: TypeScript 5.x + React 18+ (Next.js frontend)
**Primary Dependencies**:
- @openai/chatkit-react (ChatKit SDK for React/Next.js)
- Next.js 14+ (App Router)
- better-auth (session management from spec 004)
- Tailwind CSS (styling framework)
- date-fns or Luxon (timezone handling)

**Storage**:
- localStorage (browser): chat panel state (open/closed boolean)
- Backend PostgreSQL (via spec 007): conversation history persistence
- Session storage: ephemeral (scroll position, input content - not persisted)

**Testing**:
- Jest + React Testing Library (component tests)
- Playwright or Cypress (E2E tests for chat workflows)
- TypeScript compiler (type checking)
- ESLint (code quality)

**Target Platform**: Modern web browsers (Chrome, Firefox, Safari, Edge - last 2 versions), responsive for desktop (≥768px) and mobile (<768px)

**Project Type**: Web application (frontend integration into existing Next.js todo app)

**Performance Goals**:
- Chat message rendering: <200ms after API response
- Conversation history load: <1s for 50 messages
- Panel animation: <300ms open/close transition
- 60fps scrolling in chat history

**Constraints**:
- Must use OpenAI ChatKit SDK (cannot use alternative chat libraries)
- Must reuse existing POST /api/chat endpoint (no new backend endpoints)
- Must use better-auth session tokens (no separate auth system)
- Must maintain 60fps main todo list performance (chat cannot degrade UI)
- Mobile-first responsive: 320px minimum width support

**Scale/Scope**:
- Single-user chat interface per authenticated session
- Conversation history pagination: 50 messages per load
- Expected usage: 10-50 chat messages per user session
- Chat panel embedded in main todo app layout (not separate route)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Note**: The constitution focuses on Python CLI development with TDD. This spec is for Next.js frontend integration - adapting principles where applicable.

### Test-First Development
- ✅ **ADAPTED**: Frontend component testing with Jest/React Testing Library before implementation
- ✅ **ADAPTED**: E2E tests for user workflows (Playwright/Cypress) written before features
- ✅ **COMPLIANCE**: Red-Green-Refactor cycle applies to TypeScript/React components
- ✅ **COMPLIANCE**: No code committed without accompanying tests
- ⚠️ **DEVIATION**: Integration tests target browser/API interaction, not Python CLI workflows
- **Justification**: Frontend requires different testing approach (component + E2E) but maintains TDD discipline

### Clean Code & Simplicity
- ✅ **COMPLIANCE**: TypeScript strict mode enforces type safety (equivalent to Python type hints)
- ✅ **COMPLIANCE**: React components kept focused and single-purpose (<150 LOC per component)
- ✅ **COMPLIANCE**: Descriptive naming conventions for components, hooks, utilities
- ✅ **COMPLIANCE**: YAGNI principle - only implement requested chat features
- ✅ **COMPLIANCE**: Avoid premature optimization (simple state management before Redux/Zustand)

### Proper Project Structure
- ✅ **ADAPTED**: Next.js App Router structure: `app/` (pages), `components/` (chat UI), `lib/` (utilities)
- ✅ **COMPLIANCE**: Clear separation: UI components, API integration, state management
- ✅ **COMPLIANCE**: Tests colocated or in `__tests__/` directories
- ✅ **COMPLIANCE**: Dependencies explicitly declared in package.json

### Data Storage
- ✅ **ADAPTED**: Frontend uses localStorage (browser in-memory equivalent) for panel state
- ✅ **COMPLIANCE**: Backend handles persistence (spec 007 PostgreSQL) - frontend is stateless
- ✅ **COMPLIANCE**: Data layer isolated in service files for future evolution

### Interface Excellence (CLI → Chat UI)
- ✅ **ADAPTED**: Clear, user-friendly chat interface replaces CLI
- ✅ **COMPLIANCE**: Helpful error messages with actionable guidance
- ✅ **COMPLIANCE**: Task status indicators (real-time feedback in chat)
- ✅ **COMPLIANCE**: Input validation with specific error messages
- ✅ **COMPLIANCE**: Human-readable, well-formatted output (chat messages)

### Tooling (UV → npm/pnpm)
- ✅ **ADAPTED**: npm or pnpm for package management (Node.js equivalent to UV)
- ✅ **COMPLIANCE**: All dependencies explicitly declared in package.json
- ✅ **COMPLIANCE**: Development dependencies (testing, linting) included
- ✅ **COMPLIANCE**: Project runnable via npm scripts

### Summary
**Status**: ✅ **PASS WITH ADAPTATIONS**

All constitution principles are honored with frontend-appropriate adaptations:
- TDD discipline maintained with component + E2E testing
- Clean code standards apply to TypeScript/React
- Proper structure follows Next.js best practices
- Data isolation maintained (localStorage + backend API)
- User interface excellence translated to chat UI
- Tooling standardized on npm/pnpm ecosystem

**No violations requiring complexity justification.**

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

**Current Project Structure**:
```text
todo-app/                        # Repository root
├── backend/                     # FastAPI REST API (spec 003)
│   ├── src/
│   ├── tests/
│   └── alembic/
├── frontend/                    # Next.js application (THIS SPEC)
│   ├── app/                     # Next.js App Router
│   │   ├── (auth)/              # Auth routes: login, register, verify-email
│   │   ├── (dashboard)/         # Dashboard routes: /dashboard, /dashboard/tasks
│   │   ├── api/                 # API routes (proxy to backend)
│   │   ├── layout.tsx           # Root layout
│   │   ├── page.tsx             # Landing page
│   │   └── LandingPage.tsx
│   ├── components/
│   │   ├── dashboard/           # Existing: Header, Sidebar, TaskList, FilterBar, etc.
│   │   ├── todo/                # Existing: TodoItem, AddTodoModal
│   │   ├── chat/                # NEW: Chat feature components (TO BE CREATED)
│   │   │   ├── ChatPanel.tsx
│   │   │   ├── ChatMessage.tsx
│   │   │   ├── ChatInput.tsx
│   │   │   └── ChatToggleButton.tsx
│   │   └── GoogleAnalytics.tsx
│   ├── lib/
│   │   ├── auth-client.ts       # better-auth client
│   │   ├── http-client.ts       # HTTP utilities
│   │   ├── api-v2.ts            # API client for backend
│   │   ├── analytics.ts
│   │   ├── chat/                # NEW: Chat-specific logic (TO BE CREATED)
│   │   │   ├── chat-api.ts
│   │   │   ├── panel-state.ts
│   │   │   └── conversation-history.ts
│   │   └── utils/               # NEW: Utilities (TO BE CREATED)
│   │       └── timezone.ts
│   ├── hooks/
│   │   ├── useTasks.ts          # Existing task management hook
│   │   └── useChat.ts           # NEW: Chat hook (TO BE CREATED)
│   ├── types/
│   │   ├── index.ts             # Existing types
│   │   └── chat.ts              # NEW: Chat types (TO BE CREATED)
│   ├── __tests__/               # NEW: Test directory (TO BE CREATED)
│   │   ├── lib/
│   │   │   ├── chat/
│   │   │   └── utils/
│   │   ├── components/chat/
│   │   └── e2e/
│   ├── middleware.ts
│   └── package.json
├── auth-server/                 # Node.js better-auth server (spec 004)
├── ai-agent/                    # OpenAI Agents SDK backend (spec 008)
│   ├── src/
│   ├── tests/
│   └── alembic/
├── mcp-server/                  # MCP server (spec 006)
├── src/                         # Original Python CLI
├── tests/                       # Python CLI tests
├── specs/                       # Feature specifications
├── history/                     # PHRs and ADRs
└── .specify/                    # SpecKit Plus framework
```

**Structure Decision**:
This is a **monorepo with multiple services**:
- **backend/** - FastAPI backend (specs 003, 007)
- **frontend/** - Next.js app (this spec integrates chat UI here)
- **auth-server/** - better-auth Node.js server (spec 004)
- **ai-agent/** - AI agent with OpenAI SDK (spec 008)
- **mcp-server/** - FastMCP server (spec 006)

The chat feature is **frontend-only integration**. All new code goes in `frontend/components/chat/` and `frontend/lib/chat/`. Backend endpoints already exist from specs 007 and 008.

**Key Integration Points**:
1. **`frontend/app/(dashboard)/layout.tsx`** - Add `<ChatToggleButton />` to dashboard layout
2. **`frontend/components/chat/ChatPanel.tsx`** - Main chat panel component
3. **`frontend/lib/chat/chat-api.ts`** - API client wrapping POST /api/chat
4. **`frontend/hooks/useTasks.ts`** - Extend to update tasks from chat operations
5. **`frontend/types/chat.ts`** - TypeScript types from data-model.md

## Complexity Tracking

**No violations detected.** Constitution Check passed with frontend-appropriate adaptations. All principles maintained.

---

## Post-Design Constitution Re-Evaluation

**Status**: ✅ **PASS**

After completing Phase 1 design artifacts (research.md, data-model.md, contracts/, quickstart.md), the constitution compliance is re-evaluated:

### Test-First Development
- ✅ **MAINTAINED**: Quickstart guide includes TDD examples for all components
- ✅ **MAINTAINED**: Unit tests written before implementation (timezone, panel-state, chat-api)
- ✅ **MAINTAINED**: Component tests precede React component code
- ✅ **MAINTAINED**: E2E tests define acceptance criteria before feature implementation

### Clean Code & Simplicity
- ✅ **MAINTAINED**: TypeScript strict mode enforced
- ✅ **MAINTAINED**: Components follow single-responsibility (ChatPanel, ChatMessage, ChatInput separated)
- ✅ **MAINTAINED**: YAGNI principle: No state management library added (React Context sufficient)
- ✅ **MAINTAINED**: Simplicity: Optimistic UI updates instead of complex WebSocket infrastructure

### Proper Project Structure
- ✅ **MAINTAINED**: Clear separation: components/, lib/chat/, lib/utils/, __tests__/
- ✅ **MAINTAINED**: API client isolated in lib/chat/chat-api.ts
- ✅ **MAINTAINED**: Type definitions centralized in lib/types/chat.ts

### Data Storage
- ✅ **MAINTAINED**: Frontend uses localStorage (browser-native, no external DB)
- ✅ **MAINTAINED**: Backend handles persistence (PostgreSQL via spec 007)
- ✅ **MAINTAINED**: Data layer isolated (API client functions separate from components)

### Interface Excellence
- ✅ **MAINTAINED**: User-friendly error messages (session expired, network error, etc.)
- ✅ **MAINTAINED**: Real-time feedback (message rendering <200ms, optimistic updates)
- ✅ **MAINTAINED**: Clear status indicators (loading states, error messages)
- ✅ **MAINTAINED**: Input validation (max length, empty message checks)

### Tooling
- ✅ **MAINTAINED**: npm package management (package.json dependencies explicit)
- ✅ **MAINTAINED**: All dev dependencies included (Jest, Playwright, ESLint, TypeScript)
- ✅ **MAINTAINED**: Project runnable via npm scripts

### Design Quality
- ✅ **NEW VALIDATION**: Data model includes comprehensive validation rules
- ✅ **NEW VALIDATION**: API contracts documented in OpenAPI 3.1 format
- ✅ **NEW VALIDATION**: Quickstart guide provides clear implementation steps
- ✅ **NEW VALIDATION**: Research decisions documented with rationales

**Conclusion**: No new violations introduced during design phase. All constitution principles remain satisfied. Implementation can proceed to Phase 2 (/sp.tasks).
